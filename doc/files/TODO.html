<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang='en'>
<head>
<title>TODO</title>
<meta content='text/html; charset=UTF-8' http-equiv='Content-Type'>
<link href='../css/style.css' media='screen' rel='stylesheet' type='text/css'>
<script type='text/javascript'>
  function popupCode(url) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }
  
  function toggleCode(id) {
    var code = document.getElementById(id)
  
    code.style.display = code.style.display != 'block' ? 'block' : 'none'
    return true
  }
  
  // Make codeblocks hidden by default
  document.writeln('<' + 'style type="text/css">.method .source pre { display: none }<\/style>')
</script>
</head>
<body class='page'>
<div class='file' id='wrapper'>
<div class='header'>
<h1 class='name'>TODO
</h1>
<div class='paths'>
TODO
</div>
<div class='last-update'>
Last Update:
<span class='datetime'>2021-12-17 22:03:33 +0900</span>
</div>
</div>
<div id='content'>
<div id='text'>
<div id='description'>
<h1 id="label-Newer+Msg">Newer Msg<span><a href="#label-Newer+Msg">&para;</a> <a href="#top">&uarr;</a></span></h1>

<pre>a lot of the doc is out of sync given the Mapi:: changes lately. need to&#x000A;fix.&#x000A;extend msgtool with support for the other kinds of msg files. things like, &#x000A;- dump properties to yaml / xml (with option on how the keys should be dumped).&#x000A;  should be fairly easy to implement. hash, with array of attach &amp; recips.&#x000A;- just write out the mime type&#x000A;- convert to the automatically guessed output type, also allowing an override&#x000A;  of some sort. have a batch mode that converts all arguments, using automatic&#x000A;  extensions, eg .vcf, .eml etc.&#x000A;- options regarding preferring rtf / html / txt output for things. like, eg&#x000A;  the output for note conversion, will be one of them i guess.&#x000A;&#x000A;fix nameid handling for sub Properties objects. needs to inherit top-level @nameid.&#x000A;&#x000A;better handling for &quot;Untitled Attachments&quot;, or attachments with no filename at all.&#x000A;maybe better handling in general for attached messages. maybe re-write filename with&#x000A;subject.&#x000A;&#x000A;do the above 2, then go for a new release.&#x000A;for this release, i want it to be pretty robust, and have better packaging.&#x000A;have the gem install 2 tools - oletool (--tree, --read, --write, --repack)&#x000A;and msgtool (--convert, --dump-attachments etc)&#x000A;fix docs, add option parsing etc etc.&#x000A;submit to the usual gem repositories etc, announce project as usable.&#x000A;&#x000A;better handling for other types of embedded ole attachments. try to recognise .wmf to&#x000A;start with. etc. 2 goals, form .eml, and for .rtf output.&#x000A;&#x000A;rtf to text support, initially. just simple strip all the crap out approach. maybe html&#x000A;later on. sometimes the only body is rtf, which is problematic. is rtf an allowed body&#x000A;type?&#x000A;&#x000A;better encoding support (i&#39;m thinking, check some things like m-dash in the non-wide&#x000A;string type. is it windows codepage?. how to know code page in general? change&#x000A;ENCODER[] to convert these to utf8 i think). I&#39;m trying to just move everything to utf8.&#x000A;then i need to make sure the mime side of that holds up.&#x000A;&#x000A;certain parsing still not correct, especially small properties directory, &#x000A;things like bools, multiavlue shorts etc.&#x000A;&#x000A;test cases for msg/properties.rb msg/rtf.rb and mime.rb&#x000A;regarding the mime fix ups. check out:</pre>
<ul><li>
<p><a target="_top" href="http://rubyforge.org/projects/rubymail">rubyforge.org/projects/rubymail</a>/, and</p>
</li><li>
<p><a target="_top" href="http://rubyforge.org/projects/mime-alt-lite">rubyforge.org/projects/mime-alt-lite</a>/</p>
</li></ul>

<p>both haven&#39;t been touched in 2 years though.</p>

<pre>get some sort of working From: header&#x000A;there doesn&#39;t appear to be a way to get an smtp address for the sender in an&#x000A;internal mail. you need to query the exchanger server, using the sender_entryid&#x000A;as far as i can tell.&#x000A;you may also get these so called &quot;X.400&quot; addresses for external recipients&#x000A;that are on the GAL (Global Address List), as custom recipients.&#x000A;(mostly complete. better way?)&#x000A;check lots of little details: encoding issues with code pages etc other&#x000A;than ascii stuff. consider Msg, Mime, Vcard etc, to check its clean. check&#x000A;timezones, inaccuracies in date handling.&#x000A;http://msdn2.microsoft.com/en-us/library/ms526761.aspx&#x000A;import guids for these?</pre>

<p>PS_ROUTING_EMAIL_ADDRESSES PS_ROUTING_ADDRTYPE PS_ROUTING_SEARCH_KEY PS_ROUTING_DISPLAY_NAME PS_ROUTING_ENTRYID</p>

<pre>check this thing i wrote:&#x000A;creating ones in ps_mapi works strangely, as ps_mapi is the top levels ones.&#x000A;don&#39;t get entries in nameid. as should match the definitions.&#x000A;however still get allocated an 8 number. that number becomes permanent...&#x000A;do something about the message class-specific range, 0x6800 through 0x7FFF.&#x000A;multivalue encoding may explain some of the unknown data in properties objs&#x000A;get some clean test msgs from somewhere&#x000A;tackle other types of msgs, such as appointments, contacts etc, converting&#x000A;to their appropriate standard types too.&#x000A;would like to look at this next. see about the content specific range&#x000A;http://en.wikipedia.org/wiki/ICalendar&#x000A;is it better/easier to go through micro formats? there are libraries for ruby&#x000A;already i think. check this out. although using IMC standards seem to make&#x000A;more sense. encoding issues?&#x000A;try contact =&gt; vcf,&#x000A;note =&gt; ?? icalendar. VTODO? / VJOURNAL?&#x000A;appointment =&gt; VEVENT?&#x000A;(initial try done. really basic vcard output supported. not difficult)&#x000A;ole code is suppopsed to be able to return guids for something too. supporting&#x000A;all this probably means creating a new file for ole/types.rb, containing all&#x000A;the various classes, and binary conversion code.&#x000A;some dubiously useful info about some unknown codes i wrote:</pre>

<p>unknown property 5ff6</p>

<pre>appears to be equal to display_name, and transmitable_display_name</pre>

<p>unknown property 5ff7</p>

<pre> recipient.properties[0x5ff7].upcase == recipient.properties.entryid&#x000A; is equivalent, but not all uppercase.&#x000A;       everything else is upper though. maybe a displayname kind of thing.&#x000A;common relationship&#x000A;      CGI.escape(msg.properties.subject.strip).tr(&#39;+&#39;, &#39; &#39;) + &#39;.EML&#39; == msg.properties.url_comp_name</pre>

<p>(28 bytes binary data and msg.properties.sender_email_address and “000”) entryids are a strange format. for internal or from exchange whatever, they have that EX:/O=XXXXXX/… otherwise, they may have SMTP in them.</p>

<pre>such as msg.properties.sent_representing_search_key&#x000A;        == &quot;SMTP:SOMEGUY@XXX.COM\000&quot;&#x000A;      but Ole::UTF16_TO_UTF8[msg2.properties.sender_entryid[/.*\000\000(.+)\000/, 1][0..-2]]&#x000A;        == &quot;SomeGuy@XXX.COM&quot;&#x000A;      for external people, entry ids have displayname and address.</pre>

<p>longer term, i want to investigate the overlap with PST stuff, like libpst, which seems to be another kind of mapi tag property storage, and try to understand the relationship with existing TNEF work also.</p>

<p>hmmmm for future work: <a target="_top" href="http://blogs.msdn.com/stephen_griffin/archive/2005/10/25/484656.aspx">blogs.msdn.com/stephen_griffin/archive/2005/10/25/484656.aspx</a></p>

<h1 id="label-Older">Older<span><a href="#label-Older">&para;</a> <a href="#top">&uarr;</a></span></h1>
<ul><li>
<p>set &#39;From&#39; in Msg#populate_headers.</p>

<pre>Notes:&#x000A;        # ways to get the sender of a mail.&#x000A;        # if external, you can do this (different for internal).&#x000A;        name, protocol, email = Ole::UTF16_TO_UTF8[msg.props.sender_entryid[24..-1]].split(/\x00/)&#x000A;        # here is an excerpt from a yaml dump.&#x000A;        # need to consider how to get it. also when its a draft, and other stuff.&#x000A;        creator_name:&#x000A;        sent_representing_name:&#x000A;        last_modifier_name:&#x000A;        sender_email_address:&#x000A;        sent_representing_email_address:&#x000A;        sender_name:</pre>
</li><li>
<p>fill out some of the tag holes. mostly done</p>
</li><li>
<p>properly integrate rtf decompression, and the html conversion from rtf</p>
</li><li>
<p>figure out some things, like entryids, and the properties directories, and the ntsecurity data 0e27.</p>

<pre>http://peach.ease.lsoft.com/scripts/wa.exe?A2=ind0207&amp;L=mapi-l&amp;P=24515&#x000A;&quot;In case anybody is interested, Exchange stores PR_NT_SECURITY_DESCRIPTOR as a header plus the regular self=-relative SECURITY_DESCRIPTOR structure. The first two bytes of the header (WORD) is the length of the header; Read these two bytes to find out how many bytes you must skip to get to the real data. Many thanks to Stephen Griffin for this info.&quot;&#x000A;using outlook spy gives an actual dump. for example:&#x000A;&lt;&lt;&#x000A;Control: SE_DACL_AUTO_INHERITED | SE_DACL_DEFAULTED | SE_DACL_PRESENT | SE_GROUP_DEFAULTED | SE_OWNER_DEFAULTED | SE_SACL_AUTO_INHERITED | SE_SACL_DEFAULTED | SE_SELF_RELATIVE&#x000A;Owner: &#x000A;        SID: S-1-5-21-1004336348-602609370-725345543-44726&#x000A;        Name: lowecha&#x000A;        DomainName: XXX&#x000A;Group: &#x000A;        SID: S-1-5-21-1004336348-602609370-725345543-513&#x000A;        Name: Domain Users&#x000A;        DomainName: XXX&#x000A;Dacl: &#x000A;                Header:&#x000A;                        AceType: ACCESS_DENIED_ACE_TYPE&#x000A;                        AceFlags: INHERITED_ACE&#x000A;                Mask: fsdrightReadBody (fsdrightListContents) | fsdrightWriteBody (fsdrightCreateItem) | fsdrightAppendMsg (fsdrightCreateContainer) | fsdrightReadProperty | fsdrightWriteProperty | fsdrightExecute | fsdrightReadAttributes | fsdrightWriteAttributes | fsdrightWriteOwnProperty | fsdrightDeleteOwnItem | fsdrightViewItem | fsdrightWriteSD | fsdrightDelete | fsdrightWriteOwner | fsdrightReadControl | fsdrightSynchronize&#x000A;                Sid:&#x000A;                        SID: S-1-5-7&#x000A;                        Name: ANONYMOUS LOGON&#x000A;                        DomainName: NT AUTHORITY&#x000A;&gt;&gt;&#x000A;Not something i care about at the moment.</pre>
</li><li>
<p>conversion of inline images. Content-Location, cid: urls etc etc.</p>

<pre>what would be cool, is conversion of outlooks text/rtf&#39;s only real &quot;feature&quot; over&#x000A;text/html - convert inline attachments to be &lt;a href&gt; links, using cid: urls to the&#x000A;actual content data, and using an &lt;img with cid: url to a converted image from the&#x000A;attach_rendering property (image data), along with the text itself. (although i think&#x000A;the rendering may actually include the text ??. that would explain why its always clipped.</pre>

<p>can these be used for contact pictures too?</p>
</li><li>
<p>entryid format cf. entry_id.h. another serialized structure. entryids are for the addressbook connection. EMS (exchange message something), AB</p>

<pre>address book. MUIDEMSAB. makes sense.</pre>
</li></ul>

<p>mapidefs.h:</p>

<pre>174    Types of message receivers   &#x000A;175 #ifndef MAPI_ORIG&#x000A;176 #define MAPI_ORIG      0             The original author   &#x000A;177 #define MAPI_TO        1          /* The primary message receiver */&#x000A;178 #define MAPI_CC        2          /* A carbon copy receiver */&#x000A;179 #define MAPI_BCC       3          /* A blind carbon copy receiver */&#x000A;180 #define MAPI_P1        0x10000000 /* A message resend */&#x000A;181 #define MAPI_SUBMITTED 0x80000000 /* This message has already been sent */&#x000A;182 #endif</pre>
</div>
<div id='context'>
</div>

</div>
</div>

<div id='footer-push'></div>
</div>
<div id='footer'>
<a href="https://github.com/rdoc/hanna-nouveau"><strong>Hanna Nouveau</strong> RDoc template</a>
</div>
</body>
</html>
